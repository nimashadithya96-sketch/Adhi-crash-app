<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADHI TURBO CRASH SIGNAL üöÄ</title>
<!-- PWA INTEGRATION 1: Link Manifest File in the head -->
<!-- NOTE: Manifest is kept for "Add to Home Screen" functionality, but Service Worker is removed. -->
<link rel="manifest" href="manifest.json"> 
<meta name="theme-color" content="#39ff14">

<style>
/* --- 1. GENERAL STYLES --- */
body { 
    font-family: 'Inter', sans-serif; 
    margin:0; 
    padding:0; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    min-height:100vh; 
    background: linear-gradient(135deg, #0f172a, #1e293b); 
    color:#fff; 
    transition: background-color 0.3s; 
}
h1 { 
    color:#39ff14; 
    margin-bottom:18px; 
    text-align:center; 
    padding-top: 30px; 
    text-shadow: 0 0 15px rgba(57, 255, 20, 0.8), 0 0 5px rgba(57, 255, 20, 0.4);
    letter-spacing: 1.5px;
    font-size: 28px;
    font-weight: 900;
}
h2 { color: #00bcd4; margin-bottom: 20px; }
label { font-size:14px; color:#a0a0a0; margin-bottom:5px; display: block; text-align: left; width: 100%; }
button { 
    padding:12px 18px; 
    border-radius:12px; 
    border:0; 
    font-weight:800; 
    cursor:pointer; 
    transition: all 0.2s ease; 
    box-shadow: 0 6px 15px rgba(0,0,0,0.4); 
}
button:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 20px rgba(0,0,0,0.5); 
}

/* --- HACKER CODE CANVAS --- */
#hackerCodeCanvas {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: -1; display: none; 
}

/* --- INPUT STYLES --- */
input { 
    padding:14px; 
    border-radius:10px; 
    border: 2px solid #3a4257; 
    width:100%; 
    text-align:center; 
    font-size:16px;
    background-color: #1a2333; 
    color: #ffffff; 
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    box-sizing: border-box; 
    margin-bottom: 0;
}
.password-wrapper { position: relative; width: 100%; }
.password-wrapper input { padding-right: 45px; }
.password-toggle { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #94a3b8; }

/* --- LAYOUT --- */
#appContent, #loginContainer, #registerContainer { 
    display:flex;
    flex-direction:column;
    align-items:center;
    width:90%;
    max-width:480px; 
    position:relative;
    padding: 40px; 
    background: #1e293b; 
    border-radius: 25px; 
    box-shadow: 0 0 30px rgba(57, 255, 20, 0.1), 0 15px 40px rgba(0,0,0,0.9); 
    border: 3px solid #2d3b50; 
    gap: 30px; 
    z-index: 10; 
}
.input-group { display:flex; flex-direction:column; gap: 5px; width:100%; margin-bottom: 15px; }

/* --- BUTTONS --- */
#generateBtn { 
    width:100%; 
    background:linear-gradient(45deg, #ff0055, #ff6600); 
    color:#fff; 
    font-size:22px; 
    text-transform: uppercase;
    margin-top: 10px;
    padding: 15px;
    box-shadow: 0 0 15px rgba(255, 0, 85, 0.4);
}
#loginBtn, #registerBtn { 
    width:100%; 
    background:linear-gradient(45deg, #00bcd4, #0096a8); 
    color:#fff; 
    font-size:18px; 
    margin-top:10px; 
}
#switchBtn { background: #4f5a77; color: #fff; font-size: 16px; margin-top: 10px; width: 100%; } 
#logoutBtn { background:#ff6b6b; color:#fff; width: 100%; } 
#historyBtn, #howBtn { background:#4f5a77; color:#fff; width:100%; }
#notificationBtn { background: #39ff14; color: #000; width: 100%; display: none; } /* Hidden by default */

/* --- REAL TIME CLOCK & WIN RATE --- */
#realTimeClockContainer {
    display: flex;
    justify-content: center;
    width: 100%;
    margin-bottom: 5px;
}
#realTimeClock {
    font-size: 48px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 10px #39ff14, 0 0 20px #39ff14;
    padding: 10px 20px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 20px;
    border: 2px solid #39ff14;
    letter-spacing: 2px;
    font-family: 'Courier New', monospace;
}
#winRateContainer {
    width: 100%;
    text-align: center;
    margin-bottom: 10px;
}
#winRateDisplay {
    font-size: 18px;
    font-weight: 800;
    padding: 8px 20px;
    border-radius: 20px;
    border: 2px solid;
    display: inline-block;
    background: rgba(0,0,0,0.4);
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    transition: all 0.5s;
}

/* --- SIGNAL OUTPUT AREA --- */
#signalOutput {
    width: 100%;
    text-align: center;
    margin-top: 15px;
    padding: 15px;
    border: 2px dashed #3a4257;
    border-radius: 15px;
    background-color: #1c2a44;
}
#signalHeader { font-size: 14px; font-weight: 500; color: #94a3b8; margin-bottom: 5px; width: 100%; }
#signalTimeDisplay {
    font-size: 38px; font-weight: 900; color: #39ff14; 
    text-shadow: 0 0 10px rgba(57, 255, 20, 0.6); margin-bottom: 15px; line-height: 1;
}
.bet-now-header #signalHeader { font-size: 20px; color: #FFDD66; font-weight: 700; margin-bottom: 0px; }
.bet-now-header #signalTimeDisplay { color: #FFDD66; font-size: 44px; text-shadow: 0 0 15px #FFDD66; }
.bet-now-highlight { padding: 10px; border-radius: 10px; background-color: rgba(255, 0, 0, 0.7); border: 3px solid #FFDD66; }

.signal-round {
    display: flex; flex-direction: column; gap: 8px; padding: 12px 15px;
    background-color: #24344d; border-radius: 8px; width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3); margin-bottom: 5px; text-align: left; font-size: 16px;
}
.multiplier-line {
    display: flex; justify-content: space-between; width: 100%; font-weight: 600;
    padding-bottom: 5px; border-bottom: 1px dashed rgba(255, 255, 255, 0.1);
}
.multiplier-line:last-child { border-bottom: none; padding-bottom: 0; }

/* --- PROMO & DISCLAIMER --- */
#promoBox {
    background-color: #2c3a57; padding: 20px; border-radius: 15px; width: 100%; text-align: center; border: 3px solid #ffaa00; margin-top: 20px;
}
#promoCodeDisplay { font-size: 28px; font-weight: 900; color: #ffaa00; margin: 10px 0; }
#playNowBtn { background: linear-gradient(90deg, #ffaa00, #ff7700); color: #000; font-size: 18px; width: 90%; margin-top: 15px; }
#copyPromoBtn { background: #555; color: #fff; font-size: 14px; padding: 8px 15px; margin-top: 5px; }
#motivationalMsg { color:#ffdd66; font-size:15px; font-weight:700; margin-top:15px; border-top: 1px solid #4f5a77; padding-top: 10px;}
#disclaimer { color: #ff6b6b; font-weight: 600; text-align: center; margin-top: 20px; padding: 15px; border: 2px dashed #ff6b6b; border-radius: 10px; background-color: rgba(255, 107, 107, 0.08); font-size: 13px; }

/* --- PRE-BET INSTRUCTION --- */
#preBetInstruction {
    background-color: #7b0000; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: 700; text-align: center; border: 2px solid #ffaa00; font-size: 15px;
}

/* --- LOADING SCREEN --- */
#loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0f172a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; }
#crashRocket { font-size: 50px; position: absolute; bottom: 30%; left: 10%; animation: flight-sequence 2s ease-in-out forwards; }
@keyframes flight-sequence { 0% { transform: translate(0, 0) rotate(-45deg); opacity: 0.5; } 50% { transform: translate(calc(60vw - 80px), -150px) rotate(-35deg); opacity: 1; } 100% { transform: translate(calc(100vw - 80px), -250px) rotate(0deg); opacity: 0.1; } }
.loading-bar { width: 80%; max-width: 300px; height: 8px; background-color: #3a4257; border-radius: 4px; overflow: hidden; margin-top: 150px; }
.progress { height: 100%; width: 0%; background-color: #39ff14; animation: progress-fill 2s forwards; }
@keyframes progress-fill { 0% { width: 0%; } 100% { width: 100%; } }
#loading-message { color: #00bcd4; font-size: 18px; font-weight: bold; margin-top: 15px; }

/* --- MODALS & ALERTS --- */
#historyModal, #howModal, #messageModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:1000; }
#historyContent, #howContent { background:#1e293b; padding:25px; border-radius:15px; width:90%; max-width:450px; max-height:85%; overflow-y:auto; border: 2px solid #3a4257; }
#messageContent { background:#1e293b; padding:30px; border-radius:15px; max-width:350px; width:80%; text-align:center; border: 3px solid #00bcd4; }
#messageText { color:#fff; font-size:18px; margin-bottom:20px; }
.bottom-actions { display: flex; flex-direction: column; width: 100%; gap: 12px; margin-top: 25px; }
.special-instruction { background: #440000; padding: 15px; border-radius: 10px; border: 2px solid #ff6b6b; font-size: 15px; font-weight: 700; color: #ffdddd; }
</style>
</head>
<body>

<!-- HACKER BACKGROUND -->
<canvas id="hackerCodeCanvas"></canvas>

<!-- LOADING SCREEN -->
<div id="loading-screen">
    <div id="crashRocket">üöÄ</div> 
    <div class="loading-bar"><div class="progress"></div></div>
    <div id="loading-message">Loading ADHI Turbo Signal System...</div>
</div>

<!-- CUSTOM MODAL -->
<div id="messageModal">
    <div id="messageContent">
        <p id="messageText">Message</p>
        <div style="display:flex; justify-content:center; gap:10px;">
            <button id="alertOKBtn" onclick="closeMessageModal()" style="background:#39ff14; color:#000;">OK</button>
            <button id="confirmCancelBtn" onclick="handleConfirm(false)" style="background:#ff6b6b; display:none;">Cancel</button>
            <button id="confirmOKBtn" onclick="handleConfirm(true)" style="background:#39ff14; color:#000; display:none;">Yes</button>
        </div>
    </div>
</div>

<!-- MAIN INTERFACE -->
<h1>ADHI TURBO CRASH SIGNAL üöÄ</h1>

<!-- LOGIN -->
<div id="loginContainer" style="display: none;">
    <h2 style="color:#00bcd4;">‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫‡∂ß ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</h2>
    <div class="input-group"><label>Username</label><input id="loginUsernameInput" type="text" placeholder="Username"></div>
    <div class="input-group"><label>Password</label>
        <div class="password-wrapper">
            <input id="loginPasswordInput" type="password" placeholder="Password">
            <span class="password-toggle" onclick="togglePW('loginPasswordInput', this)">üëÅÔ∏è</span>
        </div>
    </div>
    <button id="loginBtn" onclick="loginUser()">LOGIN</button>
    <button id="switchBtn" onclick="showRegister()">REGISTER NOW</button>
</div>

<!-- REGISTER -->
<div id="registerContainer" style="display: none;">
    <h2 style="color:#ffaa00;">‡∂±‡∑Ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±</h2>
    <div class="input-group"><label>Username</label><input id="regUsernameInput" type="text" placeholder="Username (Min 4 chars)"></div>
    <div class="input-group"><label>Password</label>
        <div class="password-wrapper">
            <input id="regPasswordInput" type="password" placeholder="Password (Min 6 chars)">
            <span class="password-toggle" onclick="togglePW('regPasswordInput', this)">üëÅÔ∏è</span>
        </div>
    </div>
    <button id="registerBtn" onclick="registerUser()">REGISTER NOW</button>
    <button id="switchBtn" onclick="showLogin()">LOGIN</button>
</div>

<!-- APP CONTENT -->
<div id="appContent" style="display: none;">
  <div class="box" style="width: 100%;"> 
    
    <!-- WIN RATE DISPLAY (Moved above generate button) -->
    <div id="winRateContainer">
        <div id="winRateDisplay">Win Rate: --%</div>
    </div>

    <!-- REAL TIME CLOCK (HIGHLIGHTED) -->
    <div id="realTimeClockContainer">
        <div id="realTimeClock">--:--:--</div>
    </div>

    <!-- BUTTON -->
    <button id="generateBtn" onclick="displayCurrentSignal()">GENERATE SIGNAL</button>
    
    <!-- OUTPUT AREA -->
    <div id="signalOutput">
        <div id="preBetInstruction" style="display: none;"></div>
        
        <div id="timeDisplayContainer">
            <div id="signalHeader">Signal ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä...</div>
            <div id="signalTimeDisplay">--:--</div>
        </div>

        <div id="signalRounds" style="width: 100%;">
            <div class="signal-round">
                <div class="multiplier-line"><span style="color:#fff;">2x:</span><span style="color:#39ff14;">‚úÖ</span></div>
                <div class="multiplier-line"><span style="color:#fff;">3x:</span><span style="color:#ffaa00;">‚ö†Ô∏èÔ∏è</span></div>
                <div class="multiplier-line"><span style="color:#fff;">5x-10x:</span><span style="color:#ff6b6b;">‚ò†Ô∏è‚ö†Ô∏èÔ∏è</span></div>
            </div>
        </div>
        <div id="statusMessage" style="color:#00bcd4; font-size:14px; margin-top:10px;">Ready...</div>
    </div>
    
    <!-- PROMO -->
    <div id="promoBox">
        <p style="font-size:14px; font-weight:600; margin-bottom:5px;">Bonus Code:</p>
        <div id="promoCodeDisplay">1x_3660569</div>
        <button id="copyPromoBtn" onclick="copyPromoCode()">Copy Code</button>
        <p id="motivationalMsg">‡∂≠‡∑Ä‡∂∏‡∂≠‡∑ä Lost ‡∂Ø? ‡∂∏‡∑ô‡∂∏ Promo Code ‡∂ë‡∂ö ‡∂∫‡∑ú‡∂Ø‡∑è ‡∂±‡∑Ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∑è Play ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. üöÄ</p>
        <button id="playNowBtn" onclick="open1xBet()">Play Now & Register</button>
    </div>

    <div id="disclaimer">‚ö†Ô∏è ‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂ü‡∑Ä‡∑ì‡∂∏: ‡∂∏‡∑ô‡∂∫ ‡∑É‡∑í‡∂∏‡∑í‡∂∫‡∑î‡∂Ω‡∑ö‡∑Ç‡∂±‡∑ä ‡∂ë‡∂ö‡∂ö‡∑í. ‡∂¢‡∂∫‡∂ú‡∑ä‚Äç‡∂ª‡∑Ñ‡∂´ ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö ‡∂±‡∑ú‡∂ö‡∂ª‡∂∫‡∑í.</div>
    
    <div class="bottom-actions">
      <button id="notificationBtn" onclick="requestNotificationPermission()">üîî Enable Notifications for 85%+ Rates</button>
      <button id="historyBtn" onclick="openHistory()">Signal History</button>
      <button id="howBtn" onclick="openHow()">‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫‡∂ß ‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä</button>
      <button id="logoutBtn" onclick="logoutUser()">Log Out</button>
    </div>

  </div>
</div>

<!-- History Modal -->
<div id="historyModal"><div id="historyContent"><h2 style="color:#39ff14; text-align:center;">History</h2><div id="historyBox"></div><button onclick="closeHistory()" style="background:#ff6b6b; width:100%; margin-top:10px; color:white;">Close</button></div></div>

<!-- How To Modal -->
<div id="howModal"><div id="howContent">
    <h2 style="color:#39ff14; text-align:center;">‡∂ã‡∂¥‡∂Ø‡∑ô‡∑É‡∑ä</h2>
    <div class="special-instruction">
        <p>Win ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂±‡∂∏‡∑ä 1xBet ‡∂±‡∑Ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä <strong>1x_3660569</strong> ‡∂ö‡∑ö‡∂≠‡∂∫‡∑ô‡∂±‡∑ä ‡∑É‡∑è‡∂Ø‡∑è 2000LKR ‡∂Ö‡∑Ä‡∂∏‡∂∫ ‡∂≠‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±.</p>
    </div>
    <p><strong>Win Rate:</strong> ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä ‡∂Ö‡∂±‡∑î‡∑Ä ‡∑Ä‡∑ô‡∂±‡∑É‡∑ä ‡∑Ä‡∂± ‡∂¢‡∂∫‡∂ú‡∑ä‚Äç‡∂ª‡∑è‡∑Ñ‡∑ì ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∑Å‡∂≠‡∂∫ ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±. 85%‡∂ß ‡∑Ä‡∑ê‡∂©‡∑í ‡∑Ä‡∑í‡∂ß Notification ‡∂Ω‡∑ê‡∂∂‡∑ö.</p>
    <p><strong>Auto Mode:</strong> Generate ‡∂∂‡∑ú‡∂≠‡∑ä‡∂≠‡∂∏ ‡∂î‡∂∂‡∂±‡∑ä‡∂±. ‡∑Ä‡∑ö‡∂Ω‡∑è‡∑Ä‡∂ß ‡∂Ö‡∂±‡∑î‡∑Ä Signal ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂∫‡∑í.</p>
    <button onclick="closeHow()" style="background:#ff6b6b; width:100%; margin-top:10px; color:white;">Close</button>
</div></div>

<script>
const PROMO_CODE = "1x_3660569";
const PARTNER_URL = "https://refpa58144.com/L?tag=d_4844655m_1236c_adhi_crash_app&site=4844655&ad=1236"; 
const LOGIN_KEY = "isLoggedIn";
const USERS_KEY = "adhiUsers";
const DEVICE_KEY = "Adhi_Device_UUID";

let historyArr = [];
let signalSchedule = {};
let lastNotifiedTime = ""; 

// New state for minute-based rate
let currentWinRate = -1; // -1 indicates not yet calculated
let lastMinute = -1; 


// --- UTILS ---
function getDeviceID() {
    let id = localStorage.getItem(DEVICE_KEY);
    if(!id) { id = Math.random().toString(36).substring(2); localStorage.setItem(DEVICE_KEY, id); }
    return id;
}
function copyPromoCode() {
    const textArea = document.createElement("textarea");
    textArea.value = PROMO_CODE;
    document.body.appendChild(textArea);
    textArea.select();
    try {
        document.execCommand('copy');
        customAlert('Promo Code Copied!');
    } catch (err) {
        customAlert('Failed to copy');
    }
    document.body.removeChild(textArea);
}
function open1xBet() { window.open(PARTNER_URL, '_blank'); }
function togglePW(id, el) {
    let x = document.getElementById(id);
    if (x.type === "password") { x.type = "text"; el.innerHTML = 'üôà'; } 
    else { x.type = "password"; el.innerHTML = 'üëÅÔ∏è'; }
}

// --- INPUT CLEARING ---
function clearAuthInputs() {
    document.getElementById('loginUsernameInput').value = '';
    document.getElementById('loginPasswordInput').value = '';
    document.getElementById('regUsernameInput').value = '';
    document.getElementById('regPasswordInput').value = '';
}

// --- SCHEDULE LOGIC ---
function generateSchedule() {
    let h=0, m=2, idx=0;
    while(h<24) {
        if(h===23 && m>57) break;
        let t = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        signalSchedule[t] = true;
        m += (idx++%2===0 ? 3 : 2);
        if(m>=60) { h++; m%=60; }
    }
}

function displayCurrentSignal() {
    if(Object.keys(signalSchedule).length === 0) generateSchedule();
    
    const now = new Date();
    const nowH = String(now.getHours()).padStart(2,'0');
    const nowM = String(now.getMinutes()).padStart(2,'0');
    const nowTime = `${nowH}:${nowM}`;
    
    const header = document.getElementById('signalHeader');
    const timeDisp = document.getElementById('signalTimeDisplay');
    const container = document.getElementById('timeDisplayContainer');
    const preBet = document.getElementById('preBetInstruction');
    const status = document.getElementById('statusMessage');

    // Reset
    container.className = '';
    preBet.style.display = 'block';
    
    if(signalSchedule[nowTime]) {
        header.innerHTML = "üö® NOW BET TIME! üöÄ";
        timeDisp.innerText = nowTime;
        container.classList.add('bet-now-highlight', 'bet-now-header');
        preBet.innerHTML = `üõë <strong>‡∂Ø‡∑ê‡∂±‡∑ä‡∂∏ BET ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!</strong> (Signal: ${nowTime})`;
        status.innerText = "Wining Chance High! ü§ë";
    } else {
        let times = Object.keys(signalSchedule).sort();
        let next = times.find(t => t > nowTime) || times[0];
        header.innerHTML = "Next Signal Time:";
        timeDisp.innerText = next;
        
        let [nh, nm] = next.split(':').map(Number);
        let pm = nm - 1; let ph = nh;
        if(pm < 0) { pm = 59; ph = (ph - 1 + 24) % 24; }
        let prevTime = `${String(ph).padStart(2,'0')}:${String(pm).padStart(2,'0')}`;
        
        preBet.innerHTML = `üõë <strong>${prevTime}</strong> ‡∑Ñ‡∑í Round 3 ‡∂∂‡∂Ω‡∑è ‡∂ä‡∂Ω‡∂ü‡∂ß BET ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.`;
        status.innerText = "‡∂ª‡∑ê‡∂≥‡∑ì ‡∑É‡∑í‡∂ß‡∑í‡∂±‡∑ä‡∂±...";
    }
    addToHistory(`Signal: ${timeDisp.innerText}`);
}

function addToHistory(msg) {
    historyArr.unshift(msg);
    if(historyArr.length > 20) historyArr.pop();
}

// --- SYSTEM ---
function updateClock() {
    const d = new Date();
    document.getElementById('realTimeClock').innerText = d.toLocaleTimeString('en-GB');
    updateWinRate(d);
}

// --- WIN RATE & NOTIFICATION LOGIC ---
function updateWinRate(now) {
    const h = now.getHours();
    const m = now.getMinutes();

    // 1. Check if the minute has changed. If not, exit early and keep the existing rate.
    if (m === lastMinute && currentWinRate !== -1) {
        // Only run notification check on subsequent seconds within the same minute
        if (currentWinRate >= 85) {
            const currentTimeStr = `${h}:${m}`;
            if (lastNotifiedTime !== currentTimeStr) {
                sendNotification("üöÄ HIGH WIN RATE ALERT! üöÄ", "Win Rate is now 85%-95%! ‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä ‡∂∏‡∑ô‡∂∫‡∂∫‡∑í.");
                lastNotifiedTime = currentTimeStr;
            }
        }
        return;
    }

    // 2. The minute has changed (or it's the first run). Calculate and set the new rate.
    lastMinute = m;

    let min=0, max=0, color="";
    let isSuperHigh = false;

    // 2.1. Determine the rate range based on time (Priority Order)
    
    // 1. Super High: 00:17-00:45 OR 16:15-16:45 (85%-95%)
    if ((h===0 && m>=17 && m<=45) || (h===16 && m>=15 && m<=45)) {
        min=85; max=95; color="#ffdd66"; // Gold/Yellow
        isSuperHigh = true;
    }
    // 2. Medium-High: xx:07 to xx:52 (75%-80%) - NEW RULE
    else if (m >= 7 && m <= 52) {
        min=75; max=80; color="#00bcd4"; // Cyan/Blue
    }
    // 3. Low: The remaining time (53 to 06) (12%-47%)
    else {
        min=12; max=47; color="#ff6b6b"; // Red
    }

    // 2.2. Generate the new rate for the entire minute
    currentWinRate = Math.floor(Math.random() * (max - min + 1)) + min;
    
    // 2.3. Update the display
    const el = document.getElementById('winRateDisplay');
    el.innerText = `Win Rate: ${currentWinRate}%`;
    el.style.color = color;
    el.style.borderColor = color;
    el.style.boxShadow = `0 0 10px ${color}`;

    // 2.4. Trigger Notification if Super High (check against the newly generated rate)
    if (isSuperHigh && currentWinRate >= 85) {
        const currentTimeStr = `${h}:${m}`;
        // Ensure notification is only sent once per minute
        if (lastNotifiedTime !== currentTimeStr) {
            sendNotification("üöÄ HIGH WIN RATE ALERT! üöÄ", "Win Rate is now 85%-95%! ‡∑Ñ‡∑ú‡∂≥‡∂∏ ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä ‡∂∏‡∑ô‡∂∫‡∂∫‡∑í.");
            lastNotifiedTime = currentTimeStr;
        }
    }
}

function requestNotificationPermission() {
    if (!("Notification" in window)) {
        customAlert("‡∂∏‡∑ô‡∂∏ ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‡∑É‡∂ª‡∂∫ Notifications ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑É‡∑Ñ‡∂∫ ‡∂±‡∑ú‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂∫‡∑í.");
    } else {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                // Not granted, so we successfully got permission
                customAlert("Notifications ‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∂∫‡∑í! ‚úÖ");
                document.getElementById('notificationBtn').style.display = 'none';
            } else {
                // Denied (either by user action or previous browser setting)
                customAlert("Notifications ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫ ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂ö‡∑ä‡∑Ç‡∑ö‡∂¥ ‡∑Ä‡∑í‡∂∫. üö´\n‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∂ú‡∑ö ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑ä‡∑É‡∂ª‡∑ä ‡∑É‡∑ê‡∂ö‡∑É‡∑î‡∂∏‡∑ä (Site Settings) ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑ô‡∂∂‡∑ä ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫‡∂ß Notification ‡∂Ö‡∑Ä‡∑É‡∂ª‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±.");
            }
        });
    }
}

function sendNotification(title, body) {
    if (Notification.permission === "granted") {
        new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/6153/6153497.png' });
    }
}

// --- AUTH & HACKER BG ---
let canvas, ctx, drops, matrixInterval;
function initHacker() {
    canvas = document.getElementById('hackerCodeCanvas');
    ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let cols = Math.floor(canvas.width/20);
    drops = Array(cols).fill(1);
}
function drawHacker() {
    ctx.fillStyle = 'rgba(15, 23, 42, 0.05)'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#0F0'; ctx.font = '15px monospace';
    for(let i=0; i<drops.length; i++) {
        let text = String.fromCharCode(33+Math.random()*94);
        ctx.fillText(text, i*20, drops[i]*20);
        if(drops[i]*20 > canvas.height && Math.random()>0.975) drops[i]=0;
        drops[i]++;
    }
}
function toggleHacker(show) {
    let c = document.getElementById('hackerCodeCanvas');
    if(show) { c.style.display='block'; if(!matrixInterval) matrixInterval=setInterval(drawHacker,50); }
    else { c.style.display='none'; clearInterval(matrixInterval); matrixInterval=null; }
}

function checkLogin() {
    if(localStorage.getItem(LOGIN_KEY)) {
        // Logged In
        document.getElementById('loginContainer').style.display='none';
        document.getElementById('registerContainer').style.display='none';
        document.getElementById('appContent').style.display='flex';
        toggleHacker(false); 
        
        // Show notification button if not granted
        if(Notification.permission !== "granted") {
            document.getElementById('notificationBtn').style.display = 'block';
        }
    } else {
        // Logged Out / Not Logged In
        document.getElementById('appContent').style.display='none'; // Explicitly hide app content
        document.getElementById('registerContainer').style.display='none'; // Ensure register is hidden
        document.getElementById('loginContainer').style.display='flex';
        toggleHacker(true);
    }
}

function loginUser() {
    let u = document.getElementById('loginUsernameInput').value;
    let p = document.getElementById('loginPasswordInput').value;
    let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
    
    if(users[u] && users[u].pw === p) {
        localStorage.setItem(LOGIN_KEY, 'true');
        clearAuthInputs(); // successfully logged in, clear inputs
        checkLogin();
    } else { customAlert("Invalid Credentials"); }
}

function registerUser() {
    let u = document.getElementById('regUsernameInput').value;
    let p = document.getElementById('regPasswordInput').value;
    if(u.length<4 || p.length<6) { customAlert("Username 4+, Password 6+ chars"); return; }
    let users = JSON.parse(localStorage.getItem(USERS_KEY) || '{}');
    if(users[u]) { customAlert("User exists"); return; }
    users[u] = { pw: p };
    localStorage.setItem(USERS_KEY, JSON.stringify(users));
    customAlert("Registered!");
    showLogin();
}

function logoutUser() {
    customConfirm("Log Out ‡∑Ä‡∑ì‡∂∏‡∂ß ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?", (res)=>{ 
        if(res) { 
            localStorage.removeItem(LOGIN_KEY); 
            clearAuthInputs(); // Log Out ‡∑Ä‡∑ñ ‡∂¥‡∑É‡∑î inputs ‡∑Ñ‡∑í‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
            checkLogin(); 
        } 
    });
}

function showRegister() { 
    clearAuthInputs(); // inputs ‡∑Ñ‡∑í‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    document.getElementById('loginContainer').style.display='none'; 
    document.getElementById('registerContainer').style.display='flex'; 
}
function showLogin() { 
    clearAuthInputs(); // inputs ‡∑Ñ‡∑í‡∑É‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±
    document.getElementById('registerContainer').style.display='none'; 
    document.getElementById('loginContainer').style.display='flex'; 
}

// --- MODAL FUNCTIONS ---
function openHistory() {
    document.getElementById('historyBox').innerHTML = historyArr.map(h => `<p style="border-bottom: 1px dotted #4f5a77; padding-bottom: 5px; margin-bottom: 5px; font-size: 14px; color: #94a3b8;">${h}</p>`).join('');
    document.getElementById('historyModal').style.display = 'flex';
}
function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }

function openHow() {
    document.getElementById('howModal').style.display = 'flex';
}
function closeHow() {
    document.getElementById('howModal').style.display = 'none';
}

// --- CUSTOM ALERTS ---
function customAlert(msg) {
    document.getElementById('messageText').innerText = msg;
    document.getElementById('alertOKBtn').style.display='block';
    document.getElementById('confirmCancelBtn').style.display='none';
    document.getElementById('confirmOKBtn').style.display='none';
    document.getElementById('messageModal').style.display='flex';
}
function customConfirm(msg, cb) {
    window.confirmCallback = cb;
    document.getElementById('messageText').innerText = msg;
    document.getElementById('alertOKBtn').style.display='none';
    document.getElementById('confirmCancelBtn').style.display='block';
    document.getElementById('confirmOKBtn').style.display='block';
    document.getElementById('messageModal').style.display='flex';
}
function closeMessageModal() { document.getElementById('messageModal').style.display='none'; }
function handleConfirm(val) { closeMessageModal(); if(window.confirmCallback) window.confirmCallback(val); }

// INIT
window.onload = () => {
    initHacker();
    checkLogin();
    setInterval(updateClock, 1000);
    // Load screen fade out logic
    setTimeout(() => { 
        document.getElementById('loading-screen').style.opacity=0; 
        setTimeout(()=>{
            document.getElementById('loading-screen').style.display='none'
        },500); 
    }, 2000);
    
    // PWA INTEGRATION 2: Service Worker Registration - ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì
    // ‡∂∏‡∑ô‡∑Ä‡∑ê‡∂±‡∑í ‡∂≠‡∂±‡∑í ‡∂ú‡∑ú‡∂±‡∑î ‡∂¥‡∂ª‡∑í‡∑É‡∂ª‡∂∫‡∂ö (single-file environment) Service Worker 
    // ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫ (URL protocol of the script (':') is not supported)
    // ‡∂á‡∂≠‡∑í‡∑Ä‡∑ì‡∂∏ ‡∑Ä‡∂Ω‡∂ö‡∑ä‡∑Ä‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∏‡∑ô‡∂∏ ‡∂ö‡∑ö‡∂≠ ‡∂ö‡∑ú‡∂ß‡∑É ‡∂â‡∑Ä‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì.
    console.log('Service Worker registration skipped due to environment limitations.');
};
</script>
</body>
</html>
